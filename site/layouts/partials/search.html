<div id="search-container">
  <input 
    type="text" 
    id="search-input" 
    placeholder="Search articles..." 
    class="search-input"
  />
  <div id="search-results" class="search-results"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script>
<script>
// Generate search index data
const pagesData = [
  {{- $pages := site.RegularPages -}}
  {{- range $index, $page := $pages -}}
    {{- if eq $page.Type "posts" -}}
  {
    id: {{ $page.Permalink | jsonify }},
    title: {{ $page.Title | jsonify }},
    url: {{ $page.Permalink | jsonify }},
    content: {{ ($page.Plain | truncate 500) | jsonify }},
    tags: {{ $page.Params.tags | default (slice) | jsonify }}
  }{{ if ne $index (sub (len $pages) 1) }},{{ end }}
    {{- end -}}
  {{- end -}}
];

// Create Lunr index
let lunrIndex;
let lunrData = {};

if (pagesData && pagesData.length > 0) {
  // Build mapping for results
  pagesData.forEach((page, idx) => {
    lunrData[idx] = page;
  });

  // Initialize Lunr index
  lunrIndex = lunr(function() {
    this.ref('id');
    this.field('title', { boost: 10 });
    this.field('content');
    this.field('tags', { boost: 5 });
    
    pagesData.forEach((page, idx) => {
      this.add({
        id: idx,
        title: page.title,
        content: page.content,
        tags: (page.tags || []).join(' ')
      });
    });
  });
}

// Search functionality
const searchInput = document.getElementById('search-input');
const searchResults = document.getElementById('search-results');

searchInput.addEventListener('input', function(e) {
  const query = e.target.value.trim();
  
  if (query.length < 2) {
    searchResults.innerHTML = '';
    return;
  }
  
  let results = [];
  
  if (lunrIndex) {
    try {
      const matches = lunrIndex.search(query);
      results = matches.slice(0, 10).map(match => lunrData[match.ref]);
    } catch (e) {
      // Fallback to simple string matching if Lunr fails
      results = pagesData.filter(page => 
        page.title.toLowerCase().includes(query.toLowerCase()) || 
        page.content.toLowerCase().includes(query.toLowerCase()) ||
        (page.tags && page.tags.some(tag => tag.toLowerCase().includes(query.toLowerCase())))
      ).slice(0, 10);
    }
  } else {
    // Fallback if pagesData is empty
    results = pagesData.filter(page => 
      page.title.toLowerCase().includes(query.toLowerCase()) || 
      page.content.toLowerCase().includes(query.toLowerCase()) ||
      (page.tags && page.tags.some(tag => tag.toLowerCase().includes(query.toLowerCase())))
    ).slice(0, 10);
  }
  
  if (results.length === 0) {
    searchResults.innerHTML = '<p>No results found for "<strong>' + query + '</strong>".</p>';
    return;
  }
  
  searchResults.innerHTML = '<p>Found ' + results.length + ' result' + (results.length !== 1 ? 's' : '') + ':</p>' + 
    results.map(result => `
      <div class="search-result">
        <h3><a href="${result.url}">${result.title}</a></h3>
        <p>${result.content}</p>
        ${result.tags && result.tags.length > 0 ? '<div class="search-tags">' + result.tags.map(tag => `<span class="tag">${tag}</span>`).join('') + '</div>' : ''}
      </div>
    `).join('');
});

// Debug: log if pagesData is empty
if (!pagesData || pagesData.length === 0) {
  console.warn('Search: No pages found in pagesData');
}
</script>

<style>
#search-container {
  margin: 2rem 0;
}

.search-input {
  width: 100%;
  padding: 0.75rem;
  font-size: 1rem;
  border: 1px solid var(--border);
  border-radius: 0.25rem;
  background: var(--entry);
  color: var(--content);
}

.search-input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 2px var(--primary)20;
}

.search-results {
  margin-top: 1.5rem;
}

.search-result {
  margin: 1.5rem 0;
  padding: 1rem;
  border-left: 3px solid var(--primary);
  background: var(--entry);
  border-radius: 0.25rem;
}

.search-result h3 {
  margin: 0 0 0.5rem 0;
}

.search-result h3 a {
  color: var(--primary);
  text-decoration: none;
}

.search-result h3 a:hover {
  text-decoration: underline;
}

.search-result p {
  margin: 0 0 0.75rem 0;
  color: var(--secondary);
  font-size: 0.95rem;
  line-height: 1.5;
}

.search-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.search-tags .tag {
  display: inline-block;
  padding: 0.25rem 0.75rem;
  background: var(--tertiary);
  color: var(--tertiary-text);
  border-radius: 0.25rem;
  font-size: 0.85rem;
}
</style>
